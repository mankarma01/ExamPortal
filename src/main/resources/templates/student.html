<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:insert="~{include/head}" >
  <title>Home</title>
</head>

<body>

  <!-- ======= Header ======= -->
  <header th:insert="~{include/header}"  id="header" class="header fixed-top d-flex align-items-center"></header>
  <!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar" th:insert="~{include/sidebar}"></aside><!-- End Sidebar-->

  <main id="main" class="main">
    <div class="pagetitle">
      <h1>Student Report</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/home">Home</a></li>
          <li class="breadcrumb-item active">Student Report</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <div class="row">

<!--    <div class="col-3">
      <a href="/studentRegistration"><button class="btn btn-primary w-100">Add Student</button></a>
    </div>-->

    </div>

    <section class="section mt-3">
      <div class="row">
        <div class="col-lg-12 text-center">

          <form action="/student">
            <div class="row">

              <div class="col-md-2 mt-3">
                <div class="form-floating mb-3">
                  <select class="form-select" id="cityId" name="cityId" onchange="getActiveCollegeByCity(this.value)" aria-label="State">
                    <option value="0">Select City</option>
                    <option value="-1">All</option>
                    <option th:each="city : ${cityList}" th:value="${city.cityId}" th:text="${city.cityName}"></option>
                  </select>
                  <label for="cityId">City</label>
                </div>
              </div>

              <div class="col-md-2 mt-3">
                <div class="form-floating mb-3">
                  <select class="form-select" id="collegeId" name="collegeId" aria-label="State">
                    <option value="0">Select College</option>
                  </select>
                  <label for="collegeId">College</label>
                </div>
              </div>


              <div class="col-lg-2 col-md-3 col-4 mt-4">
                <button class="btn btn-primary w-100" type="submit" id="search"><i class="bi bi-search"> Search</i></button>
              </div>

              <div class="col-lg-3 col-md-4 col-6 mt-4 mb-2">
                <button class="btn btn-primary w-100" type="button" id="excelExportButton"><i class="bi bi-download"></i>Export XLSX</button>
              </div>

            </div>
          </form>

          <div class="card">
            <div class="card-body scrollable-table">

              <table class="table datatable" id="studentTable">
                <thead>
                <tr>
                  <th>No.</th>
                  <th>Name</th>
                  <th>Father Name</th>
                  <th>Enrollment</th>
                  <th>Mobile</th>
                  <th>Email</th>
                  <th>City</th>
                  <th>Collage</th>
                  <th>Course</th>
                  <th>Branch</th>
                  <th>Technology</th>
                  <th>Alt Mobile</th>
                  <th>Address</th>
                  <th>Grad</th>
                  <th>CGPA</th>
                  <th data-type="date" data-format="YYYY/DD/MM">Date Time</th>
                  <th>Delete</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
              <!-- End Table with stripped rows -->

            </div>
          </div>

        </div>
      </div>
    </section>




  </main>
  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer" th:insert="~{include/footer}"></footer>

  <script>

    function getActiveCollegeByCity(cityId){

    $.ajax({
        type: 'GET',
        url: baseUrl + 'collegeAPI/getActiveByCity/' + cityId ,
        success: function (response) {
            if (response.result) {

                let selectOption = '<option value="0">Select College</option>';

                response.data.forEach(function (college, index) {

                selectOption += `
                        <option value="${college.collegeId}">${college.collegeName}</option>
                `;
                });

                $('#collegeId').html(selectOption);


            let urlParams = new URLSearchParams(window.location.search);
            let collegeIdVal = urlParams.get('collegeId');

            if(collegeIdVal==null){
            $('#collegeId').val(0)
            }
            $('#collegeId').val(collegeIdVal)

            } else {
                $('#collegeId').html('<option value="0">No Colleges Available</option>');
            }

        },
        error: function (xhr, status, error) {
            console.error('Error occurred:', status, error);
            //alert('An error occurred while processing your request. Please try again, or contact support if the issue persists.');
        }
    });

}



  </script>


  <script>

    let urlParams = new URLSearchParams(window.location.search);
    let collegeId = urlParams.get('collegeId');
    let cityId = urlParams.get('cityId');

    if(collegeId==null){
    collegeId = 0;
    }

    if(cityId==null){
    cityId = 0;
    }

    if(cityId>0 || cityId==-1){
    getActiveCollegeByCity(cityId);
    }

    $('#cityId').val(cityId);
    $('#collegeId').val(collegeId);


  function getAllStudent(){
  const urlParams = new URLSearchParams(window.location.search);
  let collegeId = urlParams.get('collegeId');
  const cityId = urlParams.get('cityId');

  if(collegeId==null){collegeId=0;}
  collegeId=collegeId;
  if(cityId==null){return;}

    $.ajax({
        url: baseUrl + 'studentAPI/getByCityCollege/' + cityId + '/'+ collegeId,
        method: 'GET',
        success: function (response) {
            if (response.result) {
                // Initialize table body
                let tableBody = '';

                // Iterate through the data array and append rows
                response.data.forEach(function (student, index) {
                const formattedDate = student.dateTime
                ? new Date(student.dateTime).toLocaleDateString('en-GB') : '-';

                    tableBody += `
                        <tr>
                            <td data-index="${index}" >${index + 1}</td>
                            <td>${student.name || '-'}</td>
                            <td>${student.fatherName || '-'}</td>
                            <td>${student.enrollmentId || '-'}</td>
                            <td>${student.mobile || '-'}</td>
                            <td>${student.email || '-'}</td>
                            <td>${student.college.city.cityName || '-'}</td>
                            <td>${student.college.collegeName || '-'}</td>
                            <td>${student.course || '-'}</td>
                            <td>${student.branch || '-'}</td>
                            <td>${student.technology || '-'}</td>
                            <td>${student.alternateMobile || '-'}</td>
                            <td>${student.address || '-'}</td>
                            <td>${student.grad || '-'}</td>
                            <td>${student.cgpa || '-'}</td>
                            <td>${formattedDate || '-'}</td>
                            <td>
                              <a href=""
                                 onclick="deleteStudent('${student.studentId}')">
                                <i class="bi bi-trash-fill" style="margin-left: 5px;"></i>
                              </a>
                            </td>
                        </tr>
                    `;
                });

                // Append rows to the table body

                $('#studentTable tbody').html(tableBody);

            } else {
                alert('No records found: ' + response.message);
            }
        },
        error: function () {
            alert('Failed to fetch student data.');
        }
    });

}
getAllStudent();
  </script>



  <script>
    function deleteStudent(questionId) {
        // Confirm before deleting
        if (confirm("Are you sure you want to delete this student?")) {
            $.ajax({
                url: baseUrl + 'studentAPI/delete/' + questionId, // Replace with your actual API endpoint
                type: 'DELETE', // HTTP method
                success: function(response) {
                    // Handle success (e.g., show a message, reload the table, etc.)
                    if(response.result){
                    alert("Student deleted successfully!");
                    window.location.reload(); // Reload the page or update the UI dynamically
                    }
                },
                error: function(xhr, status, error) {
                    // Handle error
                    console.error("Error deleting student:", error);
                    alert("Failed to delete the Student record. Please try again.");
                }
            });
        }
    }

  </script>

  <script>
    document.getElementById('excelExportButton').addEventListener('click', function () {
      // Get the table element
      var table = document.getElementById('studentTable');

      // Create a worksheet from the HTML table
      var wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });

      // Export the worksheet to an Excel file
      XLSX.writeFile(wb, "table_data.xlsx");
    });
  </script>


  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <div  th:insert="~{include/vendor-js}"></div>

</body>

</html>